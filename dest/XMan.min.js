/**
 * Created by yataozhang on 9/25/15.
 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module){module.exports=a()}else{if("function"==typeof define&&define.amd){define([],a())}else{var b;if("undefined"!=typeof window){b=window}else{"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self)}b.x=a()}}}(function(){var d=function(){this.manger=new a();e.each(["Jsonp","CORS","Frame","FrameForm"],function(j){this[j]=this.manger["get"+j]()},this)};var a=function(){this.obtainId=(function(){var j=0;return function(k){return(k||"obtainId_")+j++}})();this.queue={}};a.prototype.getJsonp=function(){var j=this;return function(m,o,n,r){var q="cb"+j.obtainId();var p="window.x."+q;var l=document.createElement("script");window.x[q]=function(s){try{r(s)}finally{delete window.x[q];l&&l.parentNode.removeChild(l)}};var k=[];e.forIn(o,function(s,t){k.push(encodeURIComponent(s)+"="+encodeURIComponent(t))});l.src=e.hasSearch(m,k.join("&")+"&"+n+"="+p);document.body.appendChild(l)}};a.prototype.getCORS=function(j){var k=(function(){if(!("XMLHttpRequest" in window)){return false}if("withCredentials" in new XMLHttpRequest){return XMLHttpRequest}if("XDomainRequest" in window){return XDomainRequest}return null})();return function(n,m,o,q,l){console.info("使用此方法必须服务器端配合.\n1:在响应头中加上Access-Control-Allow-Origin\n2:需要前端携带凭据的话,则后端必须加上Access-Control-Allow-Credentials:true\n3:"+"如果需要自定义头信息则响应头必须加上Access-Control-Request-Headers和Access-Control-Allow-Headers\n详情请参考http://www.w3.org/TR/cors/");if(!k){console.warn("[WARN] 当前浏览器支持此功能,请常识其他方式进行跨域请求.");return}l=l||{};var p=new k;p.open(n,m);e.forIn(l.headers,function(r,s){p.setRequestHeader(r,s)});p.withCredentials=!!l.withCredentials;p.onload=function(){q(p.responseText)};p.send(o)}};a.prototype.getFrame=function(){return function(j){return new i(j)}};a.prototype.createIframe=function(j){var l,m=this;try{l=document.createElement('<iframe name="'+j+'">')}catch(k){l=document.createElement("iframe")}l.name=j;l.style.display="none";document.body.appendChild(l);l.onload=function(){var n=m.queue[l.name];if(n){try{n(l.contentWindow.name)}finally{l.parentNode.removeChild(l)}}}};a.prototype.getFrameForm=function(){var k=null,j=this;return function(n,m,p,q,o){if(k===null){k=document.createElement("form");document.body.appendChild(k)}var l=j.obtainId();j.createIframe(l);k.method=n;k.enctype=o||"application/x-www-form-urlencoded";k.setAttribute("target",l);k.action=m;j.queue[l]=q;k.innerHTML="";e.forIn(p,function(s,t){var r=document.createElement("input");r.type="hidden";r.name=s;r.value=t;k.appendChild(r)});k.submit()}};var i=function(j){this.target=j;this.frameHandle=g();this.frameHandle.init()};i.prototype={on:function(k,j){this.frameHandle["on"+k]=function(l){j(l)}},send:function(k){var j=this;j.frameHandle.postMessage(k,j.target)},emit:function(j,l){var k=this;k.frameHandle.postMessage({type:"event",eventName:j,param:l||{}},k.target)},fire:function(j,k){this.frameHandle.dispatchEvent(j,k)}};var g=(function(){var j={DEBUG:false,supportPostMessage:(function(){if(window.postMessage){try{return window.postMessage.toString().indexOf("[native code]")>=0}catch(k){return true}}return false})()};return function(){return{postMessage:function(l,k){if(typeof l==="object"){l=e.stringify(l)}if(typeof l!=="string"||!k){this.dispatchEvent("Error",["发送的信息格式出现问题"]);if(j.DEBUG){console.log("[WARN] the message is not a string type or the target window is not exist.")}return}this.sendMessage(l,k);this.dispatchEvent("PostMessage",[l,k])},setEventDelegate:function(k){this.eventDelegate=k},eventDelegate:this,dispatchEvent:function(m,k){var l=this;if(this.eventDelegate){l=this.eventDelegate}if(typeof l["on"+m]==="function"){if(l.DEBUG){console.log("[LOG] call the delegate function `on"+m+"` of the obj:",l," successful")}if(Object.prototype.toString.call(k)==="[object Array]"||typeof k==="object"&&k.length){l["on"+m].apply(l,k)}else{l["on"+m].apply(l)}return l}if(l.DEBUG){console.log("[WARN] the delegate function `on"+m+"` of the crossDomainOuter is not a function")}return false},bind:function(m,l,k){if(!m||typeof k!=="function"){return}if(m.addEventListener){m.addEventListener(l,k,false)}else{if(m.attachEvent){m.attachEvent("on"+l,k)}}},sendMessage:function(l,k){if(j.DEBUG){console.log("[LOG] will send message to innerWindow:",k,", message is:",l)}if(j.supportPostMessage){k.postMessage(l,"*")}else{k.name=l}},init:function(){var k=this;this.eventDelegate=this;var l=function(m){if(m.type==="event"){k.dispatchEvent(m.eventName,[m.param])}else{k.dispatchEvent("Message",[m])}};if(j.supportPostMessage){this.bind(window,"message",function(m){if(m.data){var n=e.parseJSON(m.data);l(n)}})}else{window.name="";k.windowName=window.name;setInterval(function(){if(window.name!==k.windowName&&window.name!==""){k.windowName=window.name;var m=e.parseJSON(k.windowName);l(m);setTimeout(function(){window.name="";k.windowName=""},20)}},100)}}}}})();var c=function(j){return function(k){return Object.prototype.toString.call(k)==="[object "+j+"]"}};var e={encodeObject2URIString:function(k){if(typeof k=="string"){return k
}var j=[];for(var l in k){if(!k.hasOwnProperty(l)||typeof k[l]==="function"){continue}j.push(encodeURIComponent(l)+"="+encodeURIComponent(k[l]))}return j.join("&")},stringify:function(p){var m=typeof p;var o=this.stringify;if(m!=="object"||p==null){if(m==="string"){p='"'+p+'"'}return String(p)}else{if(typeof JSON==="object"&&JSON.stringify){return JSON.stringify(p)}var k;var l=[];var j=p&&p.constructor===Array;for(var q in p){k=p[q];m=typeof k;if(p.hasOwnProperty(q)){if(m==="string"){k='"'+k+'"'}else{if(m==="object"&&k!=null){k=o(k)}}l.push((j?"":'"'+q+'":')+String(k))}}return(j?"[":"{")+String(l)+(j?"]":"}")}},parseJSON:function(l){var j=/^[\],:{}\s]*$/;var k=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g;var m=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g;var n=/(?:^|:|,)(?:\s*\[)+/g;if(typeof l==="object"){return l}if(typeof l!=="string"||!l){return null}l=l.replace(/(^\s+)|(\s+$)/g,"");if(j.test(l.replace(k,"@").replace(m,"]").replace(n,""))){return window.JSON&&window.JSON.parse?window.JSON.parse(l):(new Function("return "+l))()}else{return l}},bind:function(k,j){if(Function.prototype.bind){return k.bind(j)}return function(){k.apply(j,arguments)}},hasSearch:function(l,k){var j="";if(/\?/.test(l)){j="&"}else{j="?"}return l+j+k},forIn:function(j,l){if(!e.isObject(j)){return}for(var k in j){if(!j.hasOwnProperty(k)){continue}l.call(null,k,j[k])}},iteral:function(j,k){if(e.isArray(j)){return e.each.apply(null,[j,k])}if(e.isObject(j)){return e.forIn.apply(null,arguments)}},each:(function(){if([].forEach){return function(j){[].forEach.apply(j,[].slice.call(arguments,1))}}return function(l,m){for(var k=0,j=l.length;k<j;k++){m.call(arguments[2],l[k],k,l)}}})(),init:function(){e.each(["Object","String","Function","Array"],function(j){e["is"+j]=c(j)})}};e.init();var f=function(j){if(!(this instanceof f)){return new f(j)}this.data=j;this.queue=[]};f.prototype.pushVerify=function(){[].push.apply(this.queue,arguments);return this};f.prototype.start=function(){var j=this;e.each(this.queue,function(k){if(!k.verify.call(j.data)){throw new Error("[VERIFY LOG] name: "+k.name+"; "+k.errorMsg||"验证出现错误,缺少失败原因")}})};var h=new d();var b=function(j){if(!e.isObject(j)){return}var k={method:"get",type:"jsonp",data:{},success:function(){},url:"",contentType:"application/x-www-form-urlencoded",callbackName:"cb",withCredentials:false,headers:{},targetWindow:window.frames[0]||window.top,cache:false};e.forIn(k,function(l){k[l]=j[l]||k[l]});f(k).pushVerify({name:"验证method",verify:function(){if(/^(get|post)$/igm.test(this.method)){if(this.method=="post"){return !/^(jsonp|frame)$/.test(this.type)}return true}},errorMsg:'[ERROR:如使用post方法则不能使用以下方式进行跨域请求"jsonp,frame"]'},{name:"验证type",verify:function(){return/^(jsonp|crossDomain|frame|formRequest)$/igm.test(this.type)},errorMsg:'[ERROR:只能使用以下方法方式进行跨域请求"jsonp,crossDoamin,frame,formRequest"]'},{name:"验证url",verify:function(){if(this.method=="get"&&/(jsonp|crossDomain|formRequest)/.test(this.type)){this.url=e.hasSearch(this.url,e.encodeObject2URIString(this.data));this.data=void 0}return true}},{name:"验证cache",verify:function(){if(this.cache===false){this.url=e.hasSearch(this.url,"_="+(Math.random()*16777215|0))}return true}}).start();switch(k.type){case"jsonp":return h["Jsonp"](k.url,k.data,k.callbackName,k.success);case"crossDomain":return h["CORS"](k.method,k.url,k.data,k.success,{headers:k.headers,withCredentials:k.withCredentials});case"frame":return h["Frame"](k.targetWindow);case"formRequest":return h["FrameForm"](k.method,k.url,k.data,k.success,k.contentType)}};e.forIn({jsonp:"Jsonp",crossDomain:"CORS",frame:"Frame",formRequest:"FrameForm"},function(j,k){b[j]=function(){return h[k].apply(null,arguments)}});b.version="0.9.0";return b});