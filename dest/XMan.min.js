/*! xMan 2015-09-26 */
!function(a){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a());else{var b;"undefined"!=typeof window&&(b=window),b.x=a()}}(function(){"use strict";var a=window.console||{log:function(){}},b=function(){this.manger=new c,g.each(["Jsonp","CORS","Frame","FrameForm"],function(a){this[a]=this.manger["get"+a]()},this)},c=function(){this.obtainId=function(){var a=0;return function(b){return(b||"obtainId_")+a++}}(),this.queue={}};c.prototype.getJsonp=function(){var a=this;return function(b,c,d,e){var f="cb"+a.obtainId(),h="window.x."+f,i=document.createElement("script");window.x[f]=function(a){try{e(a)}finally{delete window.x[f],i.parentNode.removeChild(i)}};var j=[];g.forIn(c,function(a,b){j.push(encodeURIComponent(a)+"="+encodeURIComponent(b))}),i.src=g.hasSearch(b,j.join("&")+"&"+d+"="+h),document.body.appendChild(i)}},c.prototype.getCORS=function(b){var c=function(){return"XMLHttpRequest"in window?"withCredentials"in new XMLHttpRequest?XMLHttpRequest:"XDomainRequest"in window?window.XDomainRequest:null:!1}();return function(b,d,e,f,h){if(a.info("使用此方法必须服务器端配合.\n1:在响应头中加上Access-Control-Allow-Origin\n2:需要前端携带凭据的话,则后端必须加上Access-Control-Allow-Credentials:true\n3:如果需要自定义头信息则响应头必须加上Access-Control-Request-Headers和Access-Control-Allow-Headers\n详情请参考http://www.w3.org/TR/cors/"),!c)return void a.warn("[WARN] 当前浏览器支持此功能,请常识其他方式进行跨域请求.");h=h||{};var i=new c;i.open(b,d),g.forIn(h.headers,function(a,b){i.setRequestHeader(a,b)}),i.withCredentials=!!h.withCredentials,i.onload=function(){f(i.responseText)},i.send(e)}},c.prototype.getFrame=function(){return function(a){return new d(a)}},c.prototype.createIframe=function(a){var b,c=this;try{b=document.createElement('<iframe name="'+a+'">')}catch(d){b=document.createElement("iframe")}b.name=a,b.style.display="none",document.body.appendChild(b),b.onload=function(){var a=c.queue[b.name];if(a)try{a(b.contentWindow.name)}finally{b.parentNode.removeChild(b)}}},c.prototype.getFrameForm=function(){var a=null,b=this;return function(c,d,e,f,h){null===a&&(a=document.createElement("form"),document.body.appendChild(a));var i=b.obtainId();b.createIframe(i),a.method=c,a.enctype=h||"application/x-www-form-urlencoded",a.setAttribute("target",i),a.action=d,b.queue[i]=f,a.innerHTML="",g.forIn(e,function(b,c){var d=document.createElement("input");d.type="hidden",d.name=b,d.value=c,a.appendChild(d)}),a.submit()}};var d=function(a){this.target=a,this.frameHandle=e(),this.frameHandle.init()};d.prototype={on:function(a,b){this.frameHandle["on"+a]=function(a){b(a)}},send:function(a){var b=this;b.frameHandle.postMessage(a,b.target)},emit:function(a,b){var c=this;c.frameHandle.postMessage({type:"event",eventName:a,param:b||{}},c.target)},fire:function(a,b){this.frameHandle.dispatchEvent(a,b)}};var e=function(){var b={DEBUG:!1,supportPostMessage:function(){if(window.postMessage)try{return window.postMessage.toString().indexOf("[native code]")>=0}catch(a){return!0}return!1}()};return function(){return{postMessage:function(c,d){return"object"==typeof c&&(c=g.stringify(c)),"string"==typeof c&&d?(this.sendMessage(c,d),void this.dispatchEvent("PostMessage",[c,d])):(this.dispatchEvent("Error",["发送的信息格式出现问题"]),void(b.DEBUG&&a.log("[WARN] the message is not a string type or the target window is not exist.")))},setEventDelegate:function(a){this.eventDelegate=a},eventDelegate:this,dispatchEvent:function(b,c){var d=this;return this.eventDelegate&&(d=this.eventDelegate),"function"==typeof d["on"+b]?(d.DEBUG&&a.log("[LOG] call the delegate function `on"+b+"` of the obj:",d," successful"),"[object Array]"===Object.prototype.toString.call(c)||"object"==typeof c&&c.length?d["on"+b].apply(d,c):d["on"+b].apply(d),d):(d.DEBUG&&a.log("[WARN] the delegate function `on"+b+"` of the crossDomainOuter is not a function"),!1)},bind:function(a,b,c){a&&"function"==typeof c&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c))},sendMessage:function(c,d){b.DEBUG&&a.log("[LOG] will send message to innerWindow:",d,", message is:",c),b.supportPostMessage?d.postMessage(c,"*"):d.name=c},init:function(){var a=this;this.eventDelegate=this;var c=function(b){"event"===b.type?a.dispatchEvent(b.eventName,[b.param]):a.dispatchEvent("Message",[b])};b.supportPostMessage?this.bind(window,"message",function(a){if(a.data){var b=g.parseJSON(a.data);c(b)}}):(window.name="",a.windowName=window.name,setInterval(function(){if(window.name!==a.windowName&&""!==window.name){a.windowName=window.name;var b=g.parseJSON(a.windowName);c(b),setTimeout(function(){window.name="",a.windowName=""},20)}},100))}}}}(),f=function(a){return function(b){return Object.prototype.toString.call(b)==="[object "+a+"]"}},g={encodeObject2URIString:function(a){if("string"==typeof a)return a;var b=[];for(var c in a)a.hasOwnProperty(c)&&"function"!=typeof a[c]&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},stringify:function(a){var b=typeof a,c=this.stringify;if("object"!==b||null===a)return"string"===b&&(a='"'+a+'"'),String(a);if("object"==typeof JSON&&JSON.stringify)return JSON.stringify(a);var d,e=[],f=a&&a.constructor===Array;for(var g in a)a.hasOwnProperty(g)&&(d=a[g],b=typeof d,"string"===b?d='"'+d+'"':"object"===b&&null!==d&&(d=c(d)),e.push((f?"":'"'+g+'":')+String(d)));return(f?"[":"{")+String(e)+(f?"]":"}")},parseJSON:function(a){var b=/^[\],:{}\s]*$/,c=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,d=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,e=/(?:^|:|,)(?:\s*\[)+/g;return"object"==typeof a?a:"string"==typeof a&&a?(a=a.replace(/(^\s+)|(\s+$)/g,""),b.test(a.replace(c,"@").replace(d,"]").replace(e,""))?window.JSON&&window.JSON.parse?window.JSON.parse(a):new Function("return "+a)():a):null},bind:function(a,b){return Function.prototype.bind?a.bind(b):function(){a.apply(b,arguments)}},hasSearch:function(a,b){var c="";return c=/\?/.test(a)?"&":"?",a+c+b},forIn:function(a,b){if(g.isObject(a))for(var c in a)a.hasOwnProperty(c)&&b.call(null,c,a[c])},iteral:function(a,b){return g.isArray(a)?g.each.apply(null,[a,b]):g.isObject(a)?g.forIn.apply(null,arguments):void 0},each:function(){return[].forEach?function(a){[].forEach.apply(a,[].slice.call(arguments,1))}:function(a,b){for(var c=0,d=a.length;d>c;c++)b.call(arguments[2],a[c],c,a)}}(),init:function(){g.each(["Object","String","Function","Array"],function(a){g["is"+a]=f(a)})}};g.init();var h=function(a){return this instanceof h?(this.data=a,void(this.queue=[])):new h(a)};h.prototype.pushVerify=function(){return[].push.apply(this.queue,arguments),this},h.prototype.start=function(){var a=this;g.each(this.queue,function(b){if(!b.verify.call(a.data))throw new Error("[VERIFY LOG] name: "+b.name+"; "+b.errorMsg||"验证出现错误,缺少失败原因")})};var i=new b,j=function(a){if(g.isObject(a)){var b={method:"get",type:"jsonp",data:{},success:function(){},url:"",contentType:"application/x-www-form-urlencoded",callbackName:"cb",withCredentials:!1,headers:{},targetWindow:window.frames[0]||window.top,cache:!1};switch(g.forIn(b,function(c){b[c]=a[c]||b[c]}),h(b).pushVerify({name:"验证method",verify:function(){return/^(get|post)$/gim.test(this.method)?"post"===this.method?!/^(jsonp|frame)$/.test(this.type):!0:void 0},errorMsg:'[ERROR:如使用post方法则不能使用以下方式进行跨域请求"jsonp,frame"]'},{name:"验证type",verify:function(){return/^(jsonp|crossDomain|frame|formRequest)$/gim.test(this.type)},errorMsg:'[ERROR:只能使用以下方法方式进行跨域请求"jsonp,crossDoamin,frame,formRequest"]'},{name:"验证url",verify:function(){return"get"===this.method&&/(jsonp|crossDomain|formRequest)/.test(this.type)&&(this.url=g.hasSearch(this.url,g.encodeObject2URIString(this.data)),this.data=void 0),!0}},{name:"验证cache",verify:function(){return this.cache===!1&&(this.url=g.hasSearch(this.url,"_="+parseInt(16777215*Math.random(),10))),!0}}).start(),b.type){case"jsonp":return i.Jsonp(b.url,b.data,b.callbackName,b.success);case"crossDomain":return i.CORS(b.method,b.url,b.data,b.success,{headers:b.headers,withCredentials:b.withCredentials});case"frame":return i.Frame(b.targetWindow);case"formRequest":return i.FrameForm(b.method,b.url,b.data,b.success,b.contentType)}}};return g.forIn({jsonp:"Jsonp",crossDomain:"CORS",frame:"Frame",formRequest:"FrameForm"},function(a,b){j[a]=function(){return i[b].apply(null,arguments)}}),j.version="0.9.0",j});