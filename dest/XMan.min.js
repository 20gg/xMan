/*! xMan 2015-09-26 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a());else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.x=a()}}(function(){"use strict";var a=function(){this.manger=new b,f.each(["Jsonp","CORS","Frame","FrameForm"],function(a){this[a]=this.manger["get"+a]()},this)},b=function(){this.obtainId=function(){var a=0;return function(b){return(b||"obtainId_")+a++}}(),this.queue={}};b.prototype.getJsonp=function(){var a=this;return function(b,c,d,e){var g="cb"+a.obtainId(),h="window.x."+g,i=document.createElement("script");window.x[g]=function(a){try{e(a)}finally{delete window.x[g],i&&i.parentNode.removeChild(i)}};var j=[];f.forIn(c,function(a,b){j.push(encodeURIComponent(a)+"="+encodeURIComponent(b))}),i.src=f.hasSearch(b,j.join("&")+"&"+d+"="+h),document.body.appendChild(i)}},b.prototype.getCORS=function(a){var b=function(){return"XMLHttpRequest"in window?"withCredentials"in new XMLHttpRequest?XMLHttpRequest:"XDomainRequest"in window?XDomainRequest:null:!1}();return function(a,c,d,e,g){if(console.info("使用此方法必须服务器端配合.\n1:在响应头中加上Access-Control-Allow-Origin\n2:需要前端携带凭据的话,则后端必须加上Access-Control-Allow-Credentials:true\n3:如果需要自定义头信息则响应头必须加上Access-Control-Request-Headers和Access-Control-Allow-Headers\n详情请参考http://www.w3.org/TR/cors/"),!b)return void console.warn("[WARN] 当前浏览器支持此功能,请常识其他方式进行跨域请求.");g=g||{};var h=new b;h.open(a,c),f.forIn(g.headers,function(a,b){h.setRequestHeader(a,b)}),h.withCredentials=!!g.withCredentials,h.onload=function(){e(h.responseText)},h.send(d)}},b.prototype.getFrame=function(){return function(a){return new c(a)}},b.prototype.createIframe=function(a){var b,c=this;try{b=document.createElement('<iframe name="'+a+'">')}catch(d){b=document.createElement("iframe")}b.name=a,b.style.display="none",document.body.appendChild(b),b.onload=function(){var a=c.queue[b.name];if(a)try{a(b.contentWindow.name)}finally{b.parentNode.removeChild(b)}}},b.prototype.getFrameForm=function(){var a=null,b=this;return function(c,d,e,g,h){null===a&&(a=document.createElement("form"),document.body.appendChild(a));var i=b.obtainId();b.createIframe(i),a.method=c,a.enctype=h||"application/x-www-form-urlencoded",a.setAttribute("target",i),a.action=d,b.queue[i]=g,a.innerHTML="",f.forIn(e,function(b,c){var d=document.createElement("input");d.type="hidden",d.name=b,d.value=c,a.appendChild(d)}),a.submit()}};var c=function(a){this.target=a,this.frameHandle=d(),this.frameHandle.init()};c.prototype={on:function(a,b){this.frameHandle["on"+a]=function(a){b(a)}},send:function(a){var b=this;b.frameHandle.postMessage(a,b.target)},emit:function(a,b){var c=this;c.frameHandle.postMessage({type:"event",eventName:a,param:b||{}},c.target)},fire:function(a,b){this.frameHandle.dispatchEvent(a,b)}};var d=function(){var a={DEBUG:!1,supportPostMessage:function(){if(window.postMessage)try{return window.postMessage.toString().indexOf("[native code]")>=0}catch(a){return!0}return!1}()};return function(){return{postMessage:function(b,c){return"object"==typeof b&&(b=f.stringify(b)),"string"==typeof b&&c?(this.sendMessage(b,c),void this.dispatchEvent("PostMessage",[b,c])):(this.dispatchEvent("Error",["发送的信息格式出现问题"]),void(a.DEBUG&&console.log("[WARN] the message is not a string type or the target window is not exist.")))},setEventDelegate:function(a){this.eventDelegate=a},eventDelegate:this,dispatchEvent:function(a,b){var c=this;return this.eventDelegate&&(c=this.eventDelegate),"function"==typeof c["on"+a]?(c.DEBUG&&console.log("[LOG] call the delegate function `on"+a+"` of the obj:",c," successful"),"[object Array]"===Object.prototype.toString.call(b)||"object"==typeof b&&b.length?c["on"+a].apply(c,b):c["on"+a].apply(c),c):(c.DEBUG&&console.log("[WARN] the delegate function `on"+a+"` of the crossDomainOuter is not a function"),!1)},bind:function(a,b,c){a&&"function"==typeof c&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c))},sendMessage:function(b,c){a.DEBUG&&console.log("[LOG] will send message to innerWindow:",c,", message is:",b),a.supportPostMessage?c.postMessage(b,"*"):c.name=b},init:function(){var b=this;this.eventDelegate=this;var c=function(a){"event"===a.type?b.dispatchEvent(a.eventName,[a.param]):b.dispatchEvent("Message",[a])};a.supportPostMessage?this.bind(window,"message",function(a){if(a.data){var b=f.parseJSON(a.data);c(b)}}):(window.name="",b.windowName=window.name,setInterval(function(){if(window.name!==b.windowName&&""!==window.name){b.windowName=window.name;var a=f.parseJSON(b.windowName);c(a),setTimeout(function(){window.name="",b.windowName=""},20)}},100))}}}}(),e=function(a){return function(b){return Object.prototype.toString.call(b)==="[object "+a+"]"}},f={encodeObject2URIString:function(a){if("string"==typeof a)return a;var b=[];for(var c in a)a.hasOwnProperty(c)&&"function"!=typeof a[c]&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},stringify:function(a){var b=typeof a,c=this.stringify;if("object"!==b||null==a)return"string"===b&&(a='"'+a+'"'),String(a);if("object"==typeof JSON&&JSON.stringify)return JSON.stringify(a);var d,e=[],f=a&&a.constructor===Array;for(var g in a)d=a[g],b=typeof d,a.hasOwnProperty(g)&&("string"===b?d='"'+d+'"':"object"===b&&null!=d&&(d=c(d)),e.push((f?"":'"'+g+'":')+String(d)));return(f?"[":"{")+String(e)+(f?"]":"}")},parseJSON:function(a){var b=/^[\],:{}\s]*$/,c=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,d=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,e=/(?:^|:|,)(?:\s*\[)+/g;return"object"==typeof a?a:"string"==typeof a&&a?(a=a.replace(/(^\s+)|(\s+$)/g,""),b.test(a.replace(c,"@").replace(d,"]").replace(e,""))?window.JSON&&window.JSON.parse?window.JSON.parse(a):new Function("return "+a)():a):null},bind:function(a,b){return Function.prototype.bind?a.bind(b):function(){a.apply(b,arguments)}},hasSearch:function(a,b){var c="";return c=/\?/.test(a)?"&":"?",a+c+b},forIn:function(a,b){if(f.isObject(a))for(var c in a)a.hasOwnProperty(c)&&b.call(null,c,a[c])},iteral:function(a,b){return f.isArray(a)?f.each.apply(null,[a,b]):f.isObject(a)?f.forIn.apply(null,arguments):void 0},each:function(){return[].forEach?function(a){[].forEach.apply(a,[].slice.call(arguments,1))}:function(a,b){for(var c=0,d=a.length;d>c;c++)b.call(arguments[2],a[c],c,a)}}(),init:function(){f.each(["Object","String","Function","Array"],function(a){f["is"+a]=e(a)})}};f.init();var g=function(a){return this instanceof g?(this.data=a,void(this.queue=[])):new g(a)};g.prototype.pushVerify=function(){return[].push.apply(this.queue,arguments),this},g.prototype.start=function(){var a=this;f.each(this.queue,function(b){if(!b.verify.call(a.data))throw new Error("[VERIFY LOG] name: "+b.name+"; "+b.errorMsg||"验证出现错误,缺少失败原因")})};var h=new a,i=function(a){if(f.isObject(a)){var b={method:"get",type:"jsonp",data:{},success:function(){},url:"",contentType:"application/x-www-form-urlencoded",callbackName:"cb",withCredentials:!1,headers:{},targetWindow:window.frames[0]||window.top,cache:!1};switch(f.forIn(b,function(c){b[c]=a[c]||b[c]}),g(b).pushVerify({name:"验证method",verify:function(){return/^(get|post)$/gim.test(this.method)?"post"==this.method?!/^(jsonp|frame)$/.test(this.type):!0:void 0},errorMsg:'[ERROR:如使用post方法则不能使用以下方式进行跨域请求"jsonp,frame"]'},{name:"验证type",verify:function(){return/^(jsonp|crossDomain|frame|formRequest)$/gim.test(this.type)},errorMsg:'[ERROR:只能使用以下方法方式进行跨域请求"jsonp,crossDoamin,frame,formRequest"]'},{name:"验证url",verify:function(){return"get"==this.method&&/(jsonp|crossDomain|formRequest)/.test(this.type)&&(this.url=f.hasSearch(this.url,f.encodeObject2URIString(this.data)),this.data=void 0),!0}},{name:"验证cache",verify:function(){return this.cache===!1&&(this.url=f.hasSearch(this.url,"_="+(16777215*Math.random()|0))),!0}}).start(),b.type){case"jsonp":return h.Jsonp(b.url,b.data,b.callbackName,b.success);case"crossDomain":return h.CORS(b.method,b.url,b.data,b.success,{headers:b.headers,withCredentials:b.withCredentials});case"frame":return h.Frame(b.targetWindow);case"formRequest":return h.FrameForm(b.method,b.url,b.data,b.success,b.contentType)}}};return f.forIn({jsonp:"Jsonp",crossDomain:"CORS",frame:"Frame",formRequest:"FrameForm"},function(a,b){i[a]=function(){return h[b].apply(null,arguments)}}),i.version="0.9.0",i});